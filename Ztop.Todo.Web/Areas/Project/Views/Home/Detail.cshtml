@{ 
    Layout = null;
    Project project = ViewBag.Model;
   // FlowwData data = ViewBag.FlowwData;
    List<ProjectProgress> progress = ViewBag.Progress;
    List<ProjectRecord> Records = ViewBag.Records;
    ViewBag.Title = "项目查看";
    Layout = "~/Areas/Project/Views/Shared/_Layout.cshtml";
    int serial = 1;
}

<script>
    $(function () {
        $("a[name='Delete']").click(function () {
            if (confirm("您确定要删除吗?")) {
                var btn = $(this);
                btn.attr("disabled", "disabled");
                var href = btn.attr("href");
                $.request(href, null, function (json) {
                    alert(json.content);
                    if (json.result == 0) {
                        btn.removeAttr("disabled");
                    } else {
                        location.href = "/Project/Home/Indx";
                    }
                });
            }
           

            return false;
        });
    });
</script>
<div class="page-header">
    <h3 class="text-center">@(project.Name)</h3>
    <div class="btn-toolbar" role="toolbar" >
        @if (project.IsDone == false)//项目状态为未完成的时候，可进行编辑和删除  更改负责人
        {
            if (Identity.UserID == project.Charge.UserId)//项目负责人
            {
                <div class="btn-group btn-group-sm">
                    <a href="/Project/Home/Create?id=@(project.ID)" class="btn btn-primary"><i class="glyphicon glyphicon-edit"></i>编辑</a>
                    @*<a href="/Project/Home/Delete?id=@(project.ID)" class="btn btn-danger" name="Delete"><i class="glyphicon glyphicon-remove-sign"></i>删除</a>*@
                </div>
                <div class="btn-group btn-group-sm">
                    <a href="/Project/Progress/Create?projectID=@(project.ID)" class="btn btn-success" data-toggle="modal" data-target="#Modal"><i class="glyphicon glyphicon-plus-sign"></i>录入工作进度信息</a>
                </div>
        
            }
            else
            {
                <div class="btn-group btn-group-sm">
                    @{ 
                        Html.RenderAction("Get", "Power", new { area = "", id = 16, Parameter = string.Format("id={0}", project.ID) });//项目编辑
                      
                    }
                </div>
                <div class="btn-group btn-group-sm">
                    @{ 
                         Html.RenderAction("Get", "Power", new { area = "", id = 19, Parameter = string.Format("projectID={0}", project.ID), Type = PowerType.Windows });//录入项目进度
                    }
                </div>

                        }

                        <div class="btn-group btn-group-sm">
                            @{ 
                                Html.RenderAction("Get", "Power", new { area = "", id = 17, Parameter = string.Format("id={0}", project.ID), name = "Delete" });//项目删除
                            }
                        </div>


                        @*if (data.FlowwDataState == FlowwDataState.None)
                        {
                            if (Identity.UserID == project.Charge.UserId)//项目负责人
                            {
                                <div class="btn-group btn-group-sm">
                                    <a href="/Floww/Post?flowDataId=@(data.ID)" class="btn btn-primary" name="Post" Url="/Project/Home/Detail?id=@(project.ID)"><i class="fa fa-arrow-up"></i>提交审核</a>
                                </div>
                            }

                        }else if (data.FlowwDataState == FlowwDataState.Checking)
                        {
                            if (data.CanCheck(Identity.UserID))
                            {

                            }

                        }*@

                <div class="btn-group btn-group-sm">
                    @{ 
                        Html.RenderAction("Get", "Power", new { area = "", id = 18, Parameter = string.Format("id={0}", project.ID), Type = PowerType.Windows });//更改项目负责人
                    }
                </div>
        }
        @if (project.ProjectUser.Any(e => e.UserId == Identity.UserID))
        {
            <div class="btn-group btn-group-sm">
                <a href="/Project/Workload/Detail?projectId=@(project.ID)" class="btn btn-warning"><i class="fa fa-star"></i>查看工作量</a>
                <a href="/Project/Situation/Create?projectId=@(project.ID)" class="btn btn-primary" data-toggle="modal" data-target="#Modal"><i class="fa fa-plus"></i>录入工作情况</a>
            </div>
        }
        else
        {
            <div class="btn-group btn-group-sm">
                @{
                    Html.RenderAction("Get", "Power", new { area = "", id = 27, Parameter = string.Format("projectId={0}", project.ID) });//查看工作量  项目参与人员可查看
                }
            </div>
                    }
   
         <div class="btn-group btn-group-sm">
             <button type="button" class="btn btn-default" onclick="history.back()"><i class="glyphicon glyphicon-arrow-left"></i>返回</button>
         </div>
    </div>
</div>


<div class="row">

    <div class="col-md-12">
        <div class="alert alert-warning">
            <span>项目删除主要对部门经理及其以上用户开放，其他用户不做开放使用</span>
        </div>
        @if (project.IsDone)
        {
            <div class="alert alert-success">
                <span>当前项目已完成！</span>
            </div>
        }

        <div class="panel panel-info">
            <div class="panel-heading">项目信息</div>
            <table class="table table-bordered table-striped">
                <tr>
                    <th>项目名称</th>
                    <td>@(project.Name)</td>
                    <th>项目编号</th>
                    <td>@(project.Serial)</td>
                </tr>
                <tr>
                    <th>登记编号</th>
                    <td>
                        @(project.Number)
                        @if (string.IsNullOrEmpty(project.Number))
                        {
                            Html.RenderAction("Get", "Power", new { area = "", id = 3, Parameter = string.Format("id={0}", project.ID),Type=PowerType.Windows });
                        }
                        else
                        {
                            Html.RenderAction("Get", "Power", new { area = "", id = 4, Parameter = string.Format("id={0}", project.ID),Type=PowerType.Windows });
                        }

                    </td>
                    <th>城市（县级）</th>
                    <td>@(project.CityName)</td>
                </tr>
                <tr>
                    <th>所属乡镇（主体）</th>
                    <td>@(project.Town)</td>
                    <th>项目类型</th>
                    <td>@(project.Type.FullName)</td>
                </tr>
                <tr>
                    <th>项目负责人</th>
                    <td>@(project.Charge != null ? project.Charge.User.RealName : "未获取负责人信息")</td>
                    <th>项目参与人员</th>
                    <td>
                        @{ 
                            var message = project.Participations != null && project.Participations.Count > 0 ? string.Join(";", project.Participations.Select(e => e.User.RealName).ToArray()) : "";
                            <text>@(message)</text>
                            if (project.IsDone == false)
                            {
                                if (project.Charge.UserId == Identity.UserID)
                                {
                                    <a href="/Project/User/AddUser?projectId=@(project.ID)&&ignoreString=@(message)" class="btn btn-sm btn-success" data-toggle="modal" data-target="#Modal"><i class="fa fa-plus"></i>添加参与人员</a>

                                }
                                else
                                {
                                    Html.RenderAction("Get", "Power", new { area = "", id = 26, Parameter = string.Format("projectId={0}&&ignoreString={1}", project.ID, message), Type = PowerType.Windows });
                                }
                            }

                        }
                 
                       
                    </td>
                </tr>
                <tr>
                    <th>备注</th>
                    <td colspan="3">
                        @(project.Mark)
                      
                    </td>
                </tr>
                @if (project.IsDone)
                {
                    <tr>
                        <th>批复文件</th>
                        <td>
                            @if (!string.IsNullOrEmpty(project.ReplyFile))
                            {
                                <a href="/@(project.ReplyFile)" class="btn btn-sm btn-primary"><i class="glyphicon glyphicon-download-alt"></i>下载项目批复文件</a>
                            }
                            else
                            {
                                <ins>无批复文件</ins>
                            }
                        </td>
                        <th>批复说明</th>
                        <td>@(project.ReplyRemark)</td>
                    </tr>
                }

            </table>
        </div>
        
    </div>
    <div class="col-xs-12">
        <div class="panel panel-warning">
            <div class="panel-heading">
                工作进度信息
            </div>
            <table class="table">
                <thead>
                    <tr>
                        <th>序号</th>
                        <th>录入时间</th>
                        <th>录入人</th>
                        <th>录入进度%</th>
                        <th>进度信息</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    @if (progress != null)
                    {
                        foreach (var item in progress)
                        {
                            <tr>
                                <td>@(serial++)</td>
                                <td>@(item.Time.ToString("yyyy-MM-dd HH:mm:ss"))</td>
                                <td>@(item.User.DisplayName)</td>
                                <td>@(item.Percent)</td>
                                <td>@(item.Remark)</td>
                                <td>
                                    @if (item.UserID == Identity.UserID)
                                    {
                                        <a href="/Progress/" class="btn btn-xs btn-primary"><i class="fa fa-edit"></i>编辑</a>
                                    }
                                    else
                                    {

                                    }
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
    <div class="col-xs-12">
        <div class="panel panel-default">
            <div class="panel-heading">
                工作情况信息
            </div>
            <table class="table">
                <thead>
                    <tr>
                        <th>序号</th>
                        <th>录入时间</th>
                        <th>录入人</th>
                        <th>工作情况</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach(var item in project.Situations)
                    {
                        <tr>
                            <td>@(item.ID)</td>
                            <td>@(item.Time.ToString("yyyy-MM-dd"))</td>
                            <td>@(item.User.RealName)</td>
                            <td>@(item.Content)</td>
                            <td>

                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
    <div class="col-xs-6">
        <div class="panel panel-success">
            <div class="panel-heading">项目情况</div>
            <ul class="list-group">
                @foreach(var item in Records)
                {
                    <li class="list-group-item"><strong>时间</strong>：【@(item.Time.ToString("yyyy-MM-dd HH:mm:ss"))】<strong>信息</strong>： @(item.Content)</li>
                }
            </ul>
        </div>
    </div>
    @*<div class="col-xs-6">
        <div class="panel panel-danger">
            <div class="panel-heading">审核信息</div>
            <table class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th>提交时间</th>
                        <th>提交人</th>
                        <th>审核人</th>
                        <th>审核时间</th>
                        <th>审核结果</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    @if (data != null && data.FlowwNodeDatas != null)
                    {
                        foreach(var item in data.FlowwNodeDatas.OrderBy(e => e.ID))
                        {
                            <tr>
                                <td>@(item.Time.ToString())</td>
                                <td>@(item.PostUser!=null?item.PostUser.RealName:"未获取")</td>
                                <td>@(item.User!=null?item.User.RealName:"未审核")</td>
                                <td>@(item.CheckTime.HasValue?item.CheckTime.ToString():"/")</td>
                                <td>@(item.State.GetDescription())</td>
                                <td>

                                    @if (item.State == FlowwNodeState.Checking)
                                    {
                                        if (item.PostUserId == Identity.UserID)//
                                        {
                                            <a href="/Floww/RollBack?" class="btn btn-xs btn-danger"><i class="fa fa-arrow-left"></i>撤回</a>
                                        }

                                        if (item.FlowwNode.UserIds.Any(e => e == Identity.UserID))//审核人
                                        {
                                            <a href="" class="btn btn-xs btn-primary"><i class="fa fa-arrows-alt"></i>审核</a>
                                        }
                                    }
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>*@
</div>



