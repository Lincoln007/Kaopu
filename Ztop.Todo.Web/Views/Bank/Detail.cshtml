
@{
    ViewBag.Title = "银行对账单";
    Layout = "~/Views/Shared/_Layout.cshtml";
    Bank bank = ViewBag.Bank??new Bank();
    if (bank.Bills == null)
    {
        bank.Bills = new List<Bill>();
    }
    bool EditFlag = ViewBag.EditFlag;
    var currentNumber = 0;
}

<h2 class="text-center">杭州智拓@(bank.Company==Company.Evaluation?"房地产土地评估":"土地规划设计")咨询有限公司@(bank.Year)年@(bank.Month)月银行对账单</h2>



@*<button type="button" class="btn btn-success" data-toggle="modal" data-target="#AddOne"><i class="glyphicon glyphicon-plus"></i>增加</button>*@
<div class="modal fade" id="AddOne" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">增加银行对账记录</h4>
            </div>
            <form class="form-horizontal">
                <div class="modal-body">
                   
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th class="text-center">编号</th>
                                <th>交易日期</th>
                                <th>交易类型（收入/支出）</th>
                                <th>金额（元）</th>
                                <th class="text-center">对方账号</th>
                                <th>类别&nbsp;</th>
                                <th>
                                    摘要/备注
                                </th>
                            </tr>
                        </thead>
                        
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary">添加</button>
                </div>
            </form>     
        </div>
    </div>
</div>
<form class="form-horizontal" id="Data" method="post">
    @if (!EditFlag)
    {
        <table class="table table-striped table-bordered">
            <thead>
                <tr>
                    <th colspan="10" class="text-center">汇总</th>
                </tr>
                <tr>
                    <td colspan="4" class="text-center">收入</td>
                    <td colspan="6" class="text-center">支出</td>
                </tr>
                <tr>
                    <td>合计</td>
                    <td>实际收入</td>
                    <td>还款</td>
                    <td>保证金退回</td>
                    <td>合计</td>
                    <td>过账</td>
                    <td>借款</td>
                    <td>保证金支出</td>
                    <td>实际支出</td>
                    <td>备用金</td>
                </tr>
            </thead>
            <tbody>

                <tr>
                    <td>@(bank.Bills.Where(e=>e.Budget==Budget.Income).Sum(e=>e.Money))</td>
                    <td>@(bank.Bills.Where(e=>e.Budget==Budget.Income&&e.Cost==Cost.RealIncome).Sum(e=>e.Money))</td>
                    <td>@(bank.Bills.Where(e => e.Budget == Budget.Income && e.Cost == Cost.Repayment).Sum(e => e.Money))</td>
                    <td>@(bank.Bills.Where(e => e.Budget == Budget.Income && e.Cost == Cost.MarginIncome).Sum(e => e.Money))</td>
                    <td>@(bank.Bills.Where(e=>e.Budget==Budget.Expense).Sum(e=>e.Money))</td>
                    <td>@(bank.Bills.Where(e => e.Budget == Budget.Expense && e.Cost == Cost.Posting).Sum(e => e.Money))</td>
                    <td>@(bank.Bills.Where(e => e.Budget == Budget.Expense && e.Cost == Cost.Load).Sum(e => e.Money))</td>
                    <td>@(bank.Bills.Where(e => e.Budget == Budget.Expense && e.Cost == Cost.MarginPay).Sum(e => e.Money))</td>
                    <td>@(bank.Bills.Where(e => e.Budget == Budget.Expense && e.Cost == Cost.RealPay).Sum(e => e.Money))</td>
                    <td>@(bank.Bills.Where(e => e.Budget == Budget.Expense && e.Cost == Cost.Petty).Sum(e => e.Money))</td>
                </tr>
            </tbody>
        </table>
        <a href="/Bank/Detail?id=@(bank.ID)&&edit=true" class="btn btn-primary"><i class="glyphicon glyphicon-edit"></i>编辑</a>
        <a href="/Bank/Download?year=@(bank.Year)&&month=@(bank.Month)&&company=@(bank.Company)" class="btn btn-success"><i class="glyphicon glyphicon-download"></i>导出</a>
    }
    else
    {
        <button type="button" class="btn btn-success" name="Plus" TargetName="@(bank.Company.ToString())"><i class="glyphicon glyphicon-plus"></i>添加</button>
        <button type="button" class="btn btn-primary" name="Save"><i class="glyphicon glyphicon-save"></i>保存</button>
    }
    <button type="button" class="btn btn-default" onclick="history.back();"><em class="glyphicon glyphicon-arrow-left"></em> 返回</button>
    <input type="hidden" name="Year" value="@(bank.Year)" />
    <input type="hidden" name="Month" value="@(bank.Month)" />
    <input type="hidden" name="Company" value="@(bank.Company)" />
    <table class="table table-striped">
        <thead>
            <tr>
                <th class="text-center">编号</th>
                <th>交易日期</th>
                <th>交易类型（收入/支出）</th>
                <th>金额（元）</th>
                <th class="text-center">对方账号</th>
                <th>类别</th>
                <th colspan="2">
                    摘要/备注
                </th>
            </tr>
        </thead>
        @if (!EditFlag)
        {
            <tbody>
                @foreach (var item in bank.Bills)
                {
                    <tr>
                        <td>@(item.Coding)</td>
                        <td>@(item.Time.ToString("yyyy-MM-dd"))</td>
                        <td>@(item.Budget.GetDescription())</td>
                        <td>@(item.Money)</td>
                        <td>@(item.Account)</td>
                        <td>@(item.Cost.GetDescription())</td>
                        <td colspan="2">@(item.Summary)</td>
                    </tr>
                }
            </tbody>
        }
        else
        {
            <tbody id="@(bank.Company.ToString())">
                @foreach(var item in bank.Bills)
                {
                    <tr>
                        <td><input type="text" name="Coding" class="form-control" value="@(item.Coding)" /></td>
                        <td><input type="text" name="Time" class="form-control" value="@(item.Time.ToString("yyyy-MM-dd"))" /></td>
                        <td>
                            <select name="Budget" class="form-control" targetIndex="@(currentNumber)">
                                @foreach(Budget budget in Enum.GetValues(typeof(Budget)))
                                {
                                    <option value="@(budget)" @(budget==item.Budget?"selected=selected":"")>@(budget.GetDescription())</option>
                                }
                            </select>
                        </td>
                        <td><input type="text" name="Money" class="form-control" value="@(item.Money)" /></td>
                        <td><input type="text" name="Account" class="form-control" value="@(item.Account)" /></td>
                        <td>
                            <select name="Cost" class="form-control" id="Cost@(currentNumber++)">
                                @foreach (Cost cost in Enum.GetValues(typeof(Cost)))
                                {
                                    if (item.Budget == Budget.Income)
                                    {
                                        if (cost == Cost.Posting)
                                        {
                                            break;
                                        }
                                        <option value="@(cost)" @(cost == item.Cost ? "selected=selected" : "")>@(cost.GetDescription())</option>
                                    }
                                    else
                                    {
                                        var index = (int)cost;

                                        if (index > 2)
                                        {
                                            <option value="@(cost)" @(cost == item.Cost ? "selected=selected" : "")>@(cost.GetDescription())</option>
                                        }
                                    }

                                }
                            </select>
                        </td>
                        <td>
                            <input type="text" name="Summary" class="form-control" value="@(item.Summary)" />
                           
                        </td>
                        <td>
                            <button type="button" class="btn btn-danger btn-xs btn-remove" style="float:right"><i class="glyphicon glyphicon-remove"></i></button>
                        </td>
                    </tr>
                }
               
            </tbody>
        }


    </table>
    @if (EditFlag)
    {
        <button type="button" class="btn btn-success" name="Plus" TargetName="@(bank.Company.ToString())"><i class="glyphicon glyphicon-plus"></i>添加</button>
        <button type="button" class="btn btn-primary" name="Save"><i class="glyphicon glyphicon-save"></i>保存</button>
    }
</form>



<div style="display:none">
    <table>
        <tbody id="add">
            <tr>
                <td><input type="text" name="Coding" class="form-control" placeholder="编号" /></td>
                <td><input type="text" name="Time" class="form-control" placeholder="交易日期" /></td>
                <td>
                    <select name="Budget" class="form-control" targetIndex="{Index}">
                        @foreach (Budget budget in Enum.GetValues(typeof(Budget)))
                        {
                            <option value="@(budget)">@(budget.GetDescription())</option>
                        }
                    </select>
                </td>
                <td><input type="text" name="Money" class="form-control" placeholder="金额" /></td>
                <td><input type="text" name="Account" class="form-control" placeholder="银行账号" /></td>
                <td>
                    <select name="Cost" class="form-control" id="Cost{Index}">
                        @foreach (Cost cost in Enum.GetValues(typeof(Cost)))
                        {
                            if (cost == Cost.Posting)
                            {
                                break;
                            }
                            <option value="@(cost)">@(cost.GetDescription())</option>
                        }
                    </select>
                </td>
                <td>
                    <input type="text" name="Summary" class="form-control" placeholder="备注/摘要" />
                </td>
                <td>
                    <button type="button" class="btn btn-danger btn-xs btn-remove" style="float:right"><i class="glyphicon glyphicon-remove"></i></button>
                </td>
            </tr>
        </tbody>

    </table>

    <select name="Cost" class="form-control" id="Income">
        @foreach (Cost cost in Enum.GetValues(typeof(Cost)))
            {
                if (cost == Cost.Posting)
                {
                    break;
                }
                <option value="@(cost)">@(cost.GetDescription())</option>
        }
    </select>
    <select name="Cost" class="form-control" id="Pay">
        @foreach (Cost cost in Enum.GetValues(typeof(Cost)))
        {
            var index = (int)cost;
            if (index > 2)
            {
                <option value="@(cost)">@(cost.GetDescription())</option>
            }

        }
    </select>  
</div>


<script>
    var addhtml = $("#add").html();
    var incomehtml = $("#Income").html();
    var payhtml = $("#Pay").html();
    $(function () {

        var indexnumber=@(currentNumber);
        $("button[name='Plus']").click(function () {
            var Targetname = $(this).attr("TargetName");
            var appendhtml = addhtml.replace(/{Index}/g, indexnumber);
            indexnumber++;
            $("#" + Targetname).append(appendhtml);
            $("input[name='Time']").datetimepicker({
                timepicker: false,
                format: 'Y-m-d',
                maxDate: '@(DateTime.Today.ToString("yyyy-MM-dd"))'
            });

            $(".btn-remove").unbind("click").bind("click", function () {
                $(this).parent().parent().remove();
            });

            $("[name='Budget']").unbind("change").bind("change",function(){
                var targetIndex=$(this).attr("targetIndex");
                var budget=$(this).val();
                var replacehtml=budget=="Income"?incomehtml:payhtml;
                $("#Cost"+targetIndex).empty().append(replacehtml);
            });
        });

        $("[name='Budget']").change(function(){
            var targetIndex=$(this).attr("targetIndex");
            var budget=$(this).val();
            var replacehtml=budget=="Income"?incomehtml:payhtml;
            $("#Cost"+targetIndex).empty().append(replacehtml);
        });


        $(".btn-remove").click(function () {
            $(this).parent().parent().remove();
        })

        $("button[name='Save']").click(function () {
        
            var data = $("#Data").serialize();
            $.request("/Bank/Save?Edit=true", data, function (json) {
                if(json.result==0){
                    alert(json.content);
                    return false;
                }else{
                    alert("成功完成编辑");
                    window.location = "/Bank/Detail?id=" + json.data.ID;
                }
              
            })
        });
    })
</script>
