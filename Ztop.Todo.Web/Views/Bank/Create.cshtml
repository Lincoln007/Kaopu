
@{
    ViewBag.Title = "银行对账";
    Layout = "~/Views/Shared/_Layout.cshtml";
    Company company = ViewBag.Company;
    
}


<form class="form-horizontal" method="post" action="" id="Data">
    <h2 class="text-center">
        杭州智拓
        <select name="Year">
            @for(var i = DateTime.Now.Year; i > 2010; i--)
            {
                <option value="@(i)">@(i)</option>
            }
        </select>
        年
        <select name="Month">
            @for(var i = 1; i < 12; i++)
            {
                <option value="@(i)" @(i==(DateTime.Now.Month-1)?"selected=selected":"")>@(i)</option>            
            }
        </select>
        月银行对账清单
    </h2>
    <div class="col-md-12">
        <h3 class="text-center">@(company==Company.Evaluation?"房地产评估咨询有限公司":"土地规划设计咨询有限公司") </h3>
        <button class="btn btn-success" type="button" name="Save"><i class="glyphicon glyphicon-upload" ></i> 保存</button>
        <button type="button" class="btn btn-primary" TargetName="@(company.ToString())" name="Plus"><i class="glyphicon glyphicon-plus"></i>添加</button>
        <input type="hidden" name="Company" value="@(company)" />
        <table class="table table-striped">
            <thead>
                <tr>
                    <th class="text-center">编号</th>
                    <th>交易日期</th>
                    <th>交易类型（收入/支出）</th>
                    <th>金额（元）</th>
                    <th class="text-center">对方单位</th>
                    <th class="text-center">类别</th>
                    <th>
                        摘要
                    </th>
                    <td>
                       
                    </td>
                </tr>
            </thead>
            <tbody id="@(company.ToString())">

            </tbody>
        </table>
    </div>
    <div class="col-md-6 col-md-offset-6">
        
    </div>
    
</form>
<form class="form-inline" method="post" enctype="multipart/form-data" action="/Bank/Upload" id="form-file">
    <input type="hidden" name="Year" value="@(DateTime.Now.Year)" />
    <input type="hidden" name="Month" value="@(DateTime.Now.Month-1)" />
    <input type="hidden" name="Company" value="@(company)" />
    <div class="form-group">
        <label for="">银行对账单Excel文件：</label>
        <input type="file" class="form-control" name="file" />
    </div>
    <button type="submit" class="btn btn-primary"><i class="glyphicon glyphicon-floppy-open"></i> 上传分析</button>
</form>

<div style="display:none">
    <table >
        <tbody id="add">
            <tr>
                <td><input type="text" name="Coding" class="form-control" placeholder="编号" /></td>
                <td><input type="text" name="Time" class="form-control" placeholder="交易日期" /></td>
                <td>
                    <select name="Budget" class="form-control" targetIndex="{Index}">
                        @foreach (Budget budget in Enum.GetValues(typeof(Budget)))
                        {
                            <option value="@(budget)">@(budget.GetDescription())</option>
                        }
                    </select>
                </td>
                <td><input type="text" name="Money" class="form-control" placeholder="金额" /></td>
                <td><input type="text" name="Account" class="form-control" placeholder="对方单位" /></td>
                <td style="width:20%;">
                    <div class="col-md-6" style="padding:0px;">
                        <select name="Cost" class="form-control" id="Cost{Index}">
                            @foreach (Cost cost in Enum.GetValues(typeof(Cost)))
                            {
                                if (cost == Cost.Posting)
                                {
                                    break;
                                }
                                <option value="@(cost)">@(cost.GetDescription())</option>
                            }
                        </select>
                    </div>
                  <div class="col-md-6" style="padding:0px;" id="Append{Index}">

                  </div>
                </td>
                <td><input type="text" name="Summary" class="form-control" placeholder="备注/摘要" /></td>
                <td>
                    <button type="button" class="btn btn-danger btn-xs btn-remove" style="float:right;"><i class="glyphicon glyphicon-remove"></i></button>
                </td>
            </tr>
        </tbody>
       
    </table>
    <select name="Cost" class="form-control" id="Income">
        @foreach (Cost cost in Enum.GetValues(typeof(Cost)))
            {
                if (cost == Cost.Posting)
                {
                    break;
                }
                <option value="@(cost)">@(cost.GetDescription())</option>
        }
    </select>
    <select name="Cost" class="form-control" id="Pay">
        @foreach (Cost cost in Enum.GetValues(typeof(Cost)))
        {
            var index = (int)cost;
            if (index > 2)
            {
                <option value="@(cost)">@(cost.GetDescription())</option>
            }

        }
    </select>  
    <div id="AppendCategory">
        <select class="form-control" name="Category">
            @foreach(Category category in Enum.GetValues(typeof(Category)))
            {
                <option value="@(category)">@(category.GetDescription())</option>
            }
        </select>
    </div>
</div>

<script>
    var addhtml = $("#add").html();
    var incomehtml = $("#Income").html();
    var payhtml = $("#Pay").html();
    var appendCategoryhtml = $("#AppendCategory").html();
    $(function () {

        var currentnumber=0;
        $("button[name='Plus']").click(function () {
            var Targetname = $(this).attr("TargetName");
            var appendhtml = addhtml.replace(/{Index}/g, currentnumber);
            currentnumber++;
            $("#" + Targetname).append(appendhtml);
            $("input[name='Time']").datetimepicker({
                timepicker: false,
                format: 'Y-m-d',
                maxDate: '@(DateTime.Today.ToString("yyyy-MM-dd"))'
            });
            $(".btn-remove").unbind("click").bind("click", function () {
                $(this).parent().parent().remove();
            });

            $("[name='Budget']").unbind("change").bind("change", function () {
                var targetIndex = $(this).attr("targetIndex");
                var buget = $(this).val();
                var replacehtml = buget == "Income" ? incomehtml : payhtml;
                $("#Cost" + targetIndex).empty().append(replacehtml);
                $("#Append" + targetIndex).empty();
            });
            $("[name='Cost']").unbind("change").bind("change", function () {
                var index = $(this).attr("id").replace("Cost", "");
                var cost = $(this).val();
                if (cost != undefined && cost != "") {
                    if (cost == "RealPay") {
                        $("#Append" + index).empty().append(appendCategoryhtml);
                    } else {
                        $("#Append" + index).empty();
                    }
                }
            });
        });

        $("button[name='Save']").click(function () {
            var data = $("#Data").serialize();
            $.request("/Bank/Save", data, function (json) {
                if (json.result == 0) {
                    alert(json.content);
                    return false;
                } else {
                    window.location = "/Bank/Detail?id=" + json.data.ID;
                }
            })
        });


        //$("#form-file").submit(function () {
        //    var data = $(this).serialize();
        //    $.request("/Bank/upload", data, function (json) {
        //        alert(json.content);
        //        if (json.result == 1) {
        //            window.location.href = "/Bank/Detail?id=" + json.data.ID;
        //        }
        //        return false;
        //    });
        //    return false;
        //});

        $("input[name='Time']").datetimepicker({
            timepicker: false,
            format: 'Y-m-d',
            maxDate: '@(DateTime.Today.ToString("yyyy-MM-dd"))'
        });

        $("select[name='Year']").change(function () {
            var val = $(this).val();
            $("input[name='Year']").val(val);
        });

        $("select[name='Month']").change(function () {
            var val = $(this).val();
            $("input[name='Month']").val(val);
        });


    })
</script>

